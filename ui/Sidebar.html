<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <?!= include('ui/CSS'); ?>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  </head>
  <body>
    <div id="sidebar-content">

      <div class="section">
        <h2>Set Writing Style</h2>
        <select id="writer-select" multiple>
          <option value="" disabled selected>Select writers...</option>
        </select>
        <select id="style-select" multiple>
          <option value="" disabled selected>Select styles...</option>
        </select>
      </div>

      <div class="section">
        <h2>Generate Suggestions</h2>
        <div class="button-container">
          <button class="action" data-action="edit">EDIT</button>
          <button class="action" data-action="rewrite">REWRITE</button>
          <button class="action" data-action="continue">CONTINUE</button>
        </div>
      </div>

      <div class="section">
        <h2>Find Quotes & Resources</h2>
        <div class="button-container">
          <button id="find-quotes">FIND QUOTES</button>
          <button id="find-resources">FIND RESOURCES</button>
        </div>
      </div>

      <div class="section">
        <h2>Highlighted text</h2>
        <p id="selected-text" class="highlighted-text"></p>
      </div>

      <div id="error-message" style="display:none;">
        <div class="error">An error occurred. Please try again.</div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script>
      $(document).ready(function() {
        $('#writer-select').select2();
        $('#style-select').select2();

        google.script.run.withSuccessHandler(function(writers) {
          writers.forEach(function(writer) {
            $('#writer-select').append(new Option(writer, writer));
          });
        }).getWriterStyles();

        google.script.run.withSuccessHandler(function(styles) {
          styles.forEach(function(style) {
            $('#style-select').append(new Option(style, style));
          });
        }).getWritingStyles();
      });

      function onSidebarLoad() {
        google.script.run.withSuccessHandler(updateSelectedText).getSelectedText();
        google.script.run.listenForSelectionChanges();
      }

      function runAction(action) {
        var text = document.getElementById('selected-text').value;
        google.script.run.withSuccessHandler(updateResults)
          .withFailureHandler(showError)
          [action](text);
      }

      function updateResults(result) {
        document.getElementById('results-container').innerHTML = result;
      }

      function updateSelectedText(text) {
        var selectedTextElement = document.getElementById('selected-text');
        selectedTextElement.textContent = text || 'No text selected';
      }

      function showError(error) {
        document.getElementById('error-message').style.display = 'block';
        document.getElementById('error-message').innerText = error.message;
      }

      function listenForSelectionChanges() {
        google.script.run.withSuccessHandler(function() {
          console.log('Listening for selection changes');
        }).listenForSelectionChanges();
      }

      // Initialize the sidebar
      google.script.run.withSuccessHandler(onSidebarLoad).getSelectedText();

      // Remove trigger when the sidebar is closed
      window.addEventListener('unload', function() {
        google.script.run.removeTrigger();
      });

      // Add event listeners to buttons
      document.querySelectorAll('.action').forEach(function(button) {
        button.addEventListener('click', function() {
          runAction(this.dataset.action);
        });
      });

      document.getElementById('find-quotes').addEventListener('click', function() {
        // Implement find quotes functionality
      });

      document.getElementById('find-resources').addEventListener('click', function() {
        // Implement find resources functionality
      });

      function updateSelectedText() {
        google.script.run.withSuccessHandler(function(text) {
          $('#selected-text').text(text);
        }).getSelectedText();
      }

      // Update selected text every 500 milliseconds
      setInterval(updateSelectedText, 500);

      // Initial update
      updateSelectedText();
    </script>
  </body>
</html>
