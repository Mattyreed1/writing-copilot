<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= include('ui/CSS') ?>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/css/select2.min.css" rel="stylesheet" />
  </head>
  <body>
    <div id="sidebar-content">
      <h3 class="section-title">Set Writing Style</h3>
      <select id="writer-select" multiple>
        <option value="" disabled>Select writers...</option>
      </select>
      <select id="style-select" multiple>
        <option value="" disabled>Select styles...</option>
      </select>

      <h3 class="section-title">Generate Suggestions</h3>
      <button class="action-button" id="edit-button">EDIT</button>
      <button class="action-button" id="rewrite-button">REWRITE</button>
      <button class="action-button" id="continue-button">CONTINUE</button>

      <h3 class="section-title">Find Quotes & Resources</h3>
      <button class="action-button" id="quotes-button">FIND QUOTES</button>
      <button class="action-button" id="resources-button">FIND RESOURCES</button>

      <h3 class="section-title">Highlighted text</h3>
      <div id="selected-text" class="highlighted-text"></div>

      <div id="results-container" style="display:none;">
        <div id="results-content"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/js/select2.min.js"></script>

    <script>
      $(document).ready(function() {
        $('#writer-select').select2();
        $('#style-select').select2();

        google.script.run.withSuccessHandler(function(writers) {
          writers.forEach(function(writer) {
            $('#writer-select').append(new Option(writer, writer));
          });
        }).getWriterStyles();

        google.script.run.withSuccessHandler(function(styles) {
          styles.forEach(function(style) {
            $('#style-select').append(new Option(style, style));
          });
        }).getWritingStyles();

        updateSelectedText();

        $('#edit-button').click(function() {
          processAction('edit');
        });

        $('#rewrite-button').click(function() {
          processAction('rewrite');
        });

        $('#continue-button').click(function() {
          processAction('continue');
        });

        // Periodically update selected text
        setInterval(updateSelectedText, 1000);
      });

      function updateSelectedText() {
        google.script.run.withSuccessHandler(function(text) {
          $('#selected-text').text(text || 'No text selected');
        }).getSelectedText();
      }

      function processAction(action) {
        var text = $('#selected-text').text();
        if (!text || text === 'No text selected') {
          alert('Please select some text in the document.');
          return;
        }

        var selectedWriters = $('#writer-select').val() || [];
        var selectedStyles = $('#style-select').val() || [];

        $('#results-container').hide();
        $('#results-content').empty();

        google.script.run.withSuccessHandler(function(result) {
          displayResults(action, result, text);
        }).withFailureHandler(function(error) {
          alert('Error: ' + error.message);
        })['generate' + capitalizeFirstLetter(action)](text, selectedWriters, selectedStyles);
      }

      function displayResults(action, result, originalText) {
        $('#results-container').show();
        $('#results-content').empty();

        if (Array.isArray(result)) {
          result.forEach(function(item, index) {
            var suggestionDiv = $('<div>').addClass('suggestion');
            var radio = $('<input type="radio" name="suggestion">').val(item);
            if (index === 0) radio.attr('checked', true);
            suggestionDiv.append(radio).append($('<span>').text(item));
            $('#results-content').append(suggestionDiv);
          });
          var applyButton = $('<button>').text('Apply Suggestion').click(function() {
            var selectedText = $('input[name="suggestion"]:checked').val();
            applySuggestion(originalText, selectedText);
          });
          $('#results-content').append(applyButton);
        } else {
          var resultDiv = $('<div>').addClass('result').text(result);
          var applyButton = $('<button>').text('Apply Suggestion').click(function() {
            applySuggestion(originalText, result);
          });
          $('#results-content').append(resultDiv).append(applyButton);
        }
      }

      function applySuggestion(originalText, newText) {
        google.script.run.withSuccessHandler(function(message) {
          alert(message);
        }).withFailureHandler(function(error) {
          alert('Error: ' + error.message);
        }).applySuggestion(originalText, newText);
      }

      function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }
    </script>
  </body>
</html>
