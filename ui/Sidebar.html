<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/js/select2.min.js"></script>
    <?!= include('ui/CSS') ?>
  </head>
  <body>
    <div id="sidebar-content">
      <h3 class="section-title">Set Writing Style</h3>
      <select id="writer-select" class="select2-container" multiple="multiple"></select>
      <select id="style-select" class="select2-container" multiple="multiple"></select>

      <h3 class="section-title">Generate Suggestions</h3>
      <button class="action-button" id="edit-button">EDIT</button>
      <button class="action-button" id="rewrite-button">REWRITE</button>
      <button class="action-button" id="continue-button">CONTINUE</button>

      <h3 class="section-title">Find Quotes & Resources</h3>
      <button class="action-button" id="quotes-button">FIND QUOTES</button>
      <button class="action-button" id="resources-button">FIND RESOURCES</button>

      <h3 class="section-title">Highlighted text</h3>
      <div id="selected-text" class="highlighted-text"></div>

      <div id="results-container" style="display:none;">
        <div id="results-content"></div>
      </div>
    </div>

    <script>
      $(document).ready(function() {
        setTimeout(function() {
          try {
            // Initialize writer select
            $('#writer-select').select2({
              dropdownParent: $('#sidebar-content'),
              width: '100%',
              placeholder: 'Select writers...',
              allowClear: true,
              multiple: true,
              closeOnSelect: false
            });

            // Initialize style select
            $('#style-select').select2({
              dropdownParent: $('#sidebar-content'),
              width: '100%',
              placeholder: 'Select styles...',
              allowClear: true,
              multiple: true,
              closeOnSelect: false
            });

            // Debug logging
            console.log('Select2 initialization complete');
            
          } catch (error) {
            console.error('Select2 initialization error:', error);
          }
        }, 100); // Small delay to ensure DOM is ready
      });

      // Load writers
      google.script.run
        .withSuccessHandler(function(writers) {
          if (writers && writers.length) {
            writers.forEach(function(writer) {
              $('#writer-select').append(new Option(writer, writer, false, false));
            });
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error loading writers:', error);
        })
        .getWriterStyles();

      // Load styles
      google.script.run
        .withSuccessHandler(function(styles) {
          if (styles && styles.length) {
            styles.forEach(function(style) {
              $('#style-select').append(new Option(style, style, false, false));
            });
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error loading styles:', error);
        })
        .getWritingStyles();

      // Add change handlers for debugging
      $('#writer-select').on('change', function() {
        console.log('Selected writers:', $(this).val());
      });

      $('#style-select').on('change', function() {
        console.log('Selected styles:', $(this).val());
      });

      updateSelectedText();

      $('#edit-button').click(function() {
        processAction('edit');
      });

      $('#rewrite-button').click(function() {
        processAction('rewrite');
      });

      $('#continue-button').click(function() {
        processAction('continue');
      });

      // Periodically update selected text
      setInterval(updateSelectedText, 1000);
    </script>
  </body>
</html>
