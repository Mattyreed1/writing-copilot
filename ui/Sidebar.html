<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <?!= include('ui/CSS'); ?>
  </head>
  <body>
    <div id="sidebar-content">
      <div class="header">
        <h1>Writing Copilot</h1>
        <div class="header-icons">
          <span class="icon">⋮</span>
          <span class="icon">×</span>
        </div>
      </div>
      
      <div class="section">
        <h2>Set Writing Style</h2>
        <select id="writer-style-select" placeholder="SELECT WRITER">
          <option></option>
        </select>
        <select id="writing-style-select" placeholder="SELECT STYLE">
          <option></option>
        </select>
      </div>

      <div class="section">
        <h2>Generate Suggestions</h2>
        <div class="button-container">
          <button id="edit-btn">EDIT</button>
          <button id="rewrite-btn">REWRITE</button>
          <button id="continue-btn">CONTINUE</button>
        </div>
      </div>

      <div id="ai-result"></div>

      <div class="section">
        <h2>Find Quotes & Resources</h2>
        <div class="button-container">
          <button id="find-quotes">FIND QUOTES</button>
          <button id="find-citations">FIND RESOURCES</button>
        </div>
      </div>

      <div id="citations-output"></div>
    </div>

    <script>
      $(function() {
        console.log('Sidebar loaded');
        
        // Load writer styles
        google.script.run.withSuccessHandler(function(styles) {
          var select = $('#writer-style-select');
          styles.forEach(function(style) {
            select.append($('<option></option>').val(style).text(style));
          });
          select.select2();
        }).getWriterStyles();

        // Load writing styles
        google.script.run.withSuccessHandler(function(styles) {
          var select = $('#writing-style-select');
          styles.forEach(function(style) {
            select.append($('<option></option>').val(style).text(style));
          });
          select.select2();
        }).getWritingStyles();

        // Initialize Select2 with multiple selection
        $('#writer-style-select, #writing-style-select').select2({
          width: '100%',
          placeholder: function() {
            return $(this).attr('placeholder');
          },
          allowClear: true
        });

        // AI Suggestions button click handlers
        $('#edit-btn').click(() => handleAIOperation('edit'));
        $('#rewrite-btn').click(() => handleAIOperation('rewrite'));
        $('#continue-btn').click(() => handleAIOperation('continue'));

        // Find quotes button click handler
        $('#find-quotes').click(function() {
          google.script.run.withSuccessHandler(function(quotes) {
            var quotesHtml = quotes.map(function(quote) {
              return '<p>"' + quote.text + '" - ' + quote.author + '</p>';
            }).join('');
            $('#citations-output').html(quotesHtml);
          }).findQuotes();
        });

        // Find citations button click handler
        $('#find-citations').click(function() {
          google.script.run.withSuccessHandler(function(citations) {
            var citationsHtml = citations.map(function(citation) {
              return '<p>' + citation.title + ' by ' + citation.author + ' (' + citation.year + ')</p>';
            }).join('');
            $('#citations-output').html(citationsHtml);
          }).findCitations();
        });
      });

      function handleAIOperation(operation) {
        var selectedWriters = $('#writer-style-select').select2('data').map(item => item.text);
        var selectedStyles = $('#writing-style-select').select2('data').map(item => item.text);
        
        if (!selectedWriters.length || !selectedStyles.length) {
          alert('Please select at least one writer style and one writing style.');
          return;
        }
        
        $('#ai-result').text('Loading...');
        
        google.script.run
          .withSuccessHandler(function(suggestion) {
            var formattedSuggestion = formatAIResponse(suggestion);
            $('#ai-result').html(formattedSuggestion);
          })
          .withFailureHandler(function(error) {
            $('#ai-result').text('Error: ' + error.message);
          })
          .getAISuggestions(selectedWriters, selectedStyles, operation);
      }
    </script>
  </body>
</html>
