<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <?!= include('ui/CSS'); ?>
  </head>
  <body>
    <div id="sidebar-content">
      <div class="header">
        <h1>Writing Copilot</h1>
        <div class="header-icons">
          <span class="icon">⋮</span>
          <span class="icon">×</span>
        </div>
      </div>
      
      <div id="no-selection-message">Select text in the Google doc.</div>
      
      <div class="section">
        <h2>Set Writing Style</h2>
        <select id="writer-style-select" multiple="multiple" placeholder="SELECT WRITER">
          <option></option>
        </select>
        <select id="writing-style-select" multiple="multiple" placeholder="SELECT STYLE">
          <option></option>
        </select>
      </div>

      <div class="section">
        <h2>Generate Suggestions</h2>
        <div class="button-container">
          <button id="edit-btn" disabled>EDIT</button>
          <button id="rewrite-btn" disabled>REWRITE</button>
          <button id="continue-btn" disabled>CONTINUE</button>
        </div>
      </div>

      <div id="ai-result" class="result-container"></div>

      <div class="section">
        <h2>Find Quotes & Resources</h2>
        <div class="button-container">
          <button id="find-quotes" disabled>QUOTES</button>
          <button id="find-citations" disabled>RESOURCES</button>
        </div>
      </div>

      <div id="citations-output" class="result-container"></div>
    </div>

    <script>
      // Fallback function to load jQuery if CDN fails
      function loadJQuery(callback) {
        if (typeof jQuery === 'undefined') {
          var script = document.createElement('script');
          script.src = 'https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js';
          script.onload = callback;
          script.onerror = function() {
            console.error('Failed to load jQuery from CDN');
          };
          document.body.appendChild(script);
        } else {
          callback();
        }
      }

      // Initialize sidebar after jQuery is loaded
      function initializeSidebar() {
        $(function() {
          // Initialize Select2 with multiple selection
          $('#writer-style-select, #writing-style-select').select2({
            width: '100%',
            placeholder: function() {
              return $(this).attr('placeholder');
            },
            allowClear: true,
            multiple: true
          });

          // Load writer styles
          google.script.run.withSuccessHandler(function(styles) {
            var select = $('#writer-style-select');
            styles.forEach(function(style) {
              select.append($('<option></option>').val(style).text(style));
            });
            select.trigger('change');
          }).getWriterStyles();

          // Load writing styles
          google.script.run.withSuccessHandler(function(styles) {
            var select = $('#writing-style-select');
            styles.forEach(function(style) {
              select.append($('<option></option>').val(style).text(style));
            });
            select.trigger('change');
          }).getWritingStyles();

          // AI Suggestions button click handlers
          $('#edit-btn').click(() => handleAIOperation('edit'));
          $('#rewrite-btn').click(() => handleAIOperation('rewrite'));
          $('#continue-btn').click(() => handleAIOperation('continue'));

          // Find quotes and resources button click handlers
          $('#find-quotes').click(handleFindQuotes);
          $('#find-citations').click(handleFindResources);

          // Check for initial text selection
          checkTextSelection();

          // Check for text selection periodically
          setInterval(checkTextSelection, 1000);
        });
      }

      // Load jQuery and initialize sidebar
      loadJQuery(initializeSidebar);
    </script>
  </body>
</html>
